[TOC]



# 一、分析vender.js文件的构成



## 1 安装依赖
首先安装webpack-bundle-analyzer
`npm install --save-dev webpack-bundle-analyzer`

大多数情况下，在windows平台下使用类似于: NODE_ENV=production的命令行指令会卡住。cross-env能跨平台地设置及使用环境变量
`npm install --save-dev cross-env`

## 2在webpack.pro.config.js

module.exports = webpackConfig结尾上面添加

```javascript
//if (config.build.bundleAnalyzerReport) {
    const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;
    /*
    module.exports = {
        plugins: [
            new BundleAnalyzerPlugin()
        ]
    }*/
    webpackConfig.plugins.push(new BundleAnalyzerPlugin())
//}
 
```

## 3、首先配置package.json

```javascript
"scripts": {
    "analyz": "cross-env NODE_ENV=production npm_config_report=true npm run build"
}
```

## 4、执行npm run build

# 二、全局剔除import引入的文件

在webpack.base.config.js中externals防止打包时，将本地node_modules中以import方式加载的包，打包进dist文件中

替换的是以在index.html中引入的第三方链接的方式

```javascript
externals: {
    'BMap': 'BMap',
    'vue': 'Vue',
    'element-ui': 'ELEMENT',
    'echarts': 'echarts',
    // 'xlsx': 'XLSX',
  },
```

但在页面中包括main.js，或者在其他的文件中仍要以import的方式引入

```javascript
// 导出excel表
import XLSX from 'xlsx'
Vue.use(XLSX)
```

# 三、按需引入第三方链接



在vue页面

```javascript
mounted() {
    (function() {
        let hm = document.createElement("script");
        hm.src = "https://unpkg.com/xlsx/dist/xlsx.full.min.js";
        let s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
},
```

这样的代码会有重复添加的问题<script>标签的问题，还需要进行删除，在vue页面也不友好

**在全局index.html页面监听地址变化**

```javascript
const _historyWrap = function(type) {
      const orig = history[type];
      const e = new Event(type);
      return function() {
        const rv = orig.apply(this, arguments);
        e.arguments = arguments;
        window.dispatchEvent(e);
        return rv;
      };
    };
    history.pushState = _historyWrap('pushState');
    history.replaceState = _historyWrap('replaceState');
    window.addEventListener('pushState', function(e) {
        console.log(window.location.pathname);        
  });
  window.addEventListener('replaceState', function(e) {
    console.log(window.location.pathname);
  });
```

## 使用render函数在vue页面加载第三方链接

**局部重复定义，在vue单个页面引用**

```javascript
components: {
    quickSelect,
    'remote-js': {
        render(createElement) {
            return createElement('script', {
                attrs: {
                    type: 'text/javascript',
                    src: this.cdn
                }
            })
        },
        props: {
            cdn:  {
                type: String,
                required: true
            }
        }
    },
    'remote-css': {
        render(createElement) {
            return createElement('link', {
                attrs: {
                    rel: 'stylesheet',
                    type: 'text/css',
                    href: this.cdn
                }
            })
        },
        props: {
            cdn:  {
                type: String,
                required: true
            }
        }
    }
  },
```

```vue
<remote-js cdn="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></remote-js>
<remote-css cdn="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css"></remote-css>
```

**全局定义，按需引用**

```javascript
Vue.component('remote-js', {
    render(createElement) {
        return createElement('script', {
            attrs: {
                type: 'text/javascript',
                src: this.cdn
            }
        })
    },
    props: {
        cdn:  {
            type: String,
            required: true
        }
    }
})
Vue.component('remote-css', {
    render(createElement) {
        return createElement('link', {
            attrs: {
                rel: 'stylesheet',
                type: 'text/css',
                href: this.cdn
            }
        })
    },
    props: {
        cdn:  {
            type: String,
            required: true
        }
    }
})
```

应用出现的问题：在引用百度地图是会出现，使用该方法仍然无法加载第三方链接

解决办法： 在引用函数中示例化BaiduMap时，使用setTimeOut

## 四、CDN链接

https://www.bootcdn.cn
